{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-sm" style="background-color: #1e1e1e; border-radius: 15px;">
                <div class="card-header bg-warning text-dark fw-bold" style="border-radius: 15px 15px 0 0;">
                    <i class="bi bi-lock-fill me-2"></i>Private Courses
                </div>
                <ul class="list-group list-group-flush" id="private-list">
                    {% for course in courses %}
                        {% if not course.is_public %}
                        <li class="list-group-item bg-dark text-white border-secondary small d-flex justify-content-between align-items-center" id="list-item-{{ course.id }}">
                            <span class="text-truncate me-2">{{ course.title }}</span>
                            <span class="badge bg-secondary">Draft</span>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {# FIXED LINE 12/13: Using a more stable display logic #}
                    <li id="no-private-msg" class="list-group-item bg-dark text-muted small d-none">
                        No private courses.
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-white fw-bold">All Courses</h2>
                <a href="{% url 'upload_course' %}" class="btn btn-primary px-4 shadow">
                    <i class="bi bi-plus-lg me-2"></i>New Course
                </a>
            </div>

            <div class="row row-cols-1 row-cols-md-2 g-4" id="course-grid">
                {% for course in courses %}
                <div class="col" id="course-card-{{ course.id }}">
                    <div class="card h-100 border-0 shadow-sm" style="background-color: #1e1e1e; color: #ffffff; border-radius: 15px; overflow: hidden;">

                        {# Image Section #}
                        <div class="position-relative">
                            {% if course.image %}
                                <img src="{{ course.image.url }}" class="card-img-top" style="height: 160px; width: 100%; object-fit: cover;">
                            {% else %}
                                <div class="bg-dark d-flex align-items-center justify-content-center border-bottom border-secondary" style="height: 160px;">
                                    <i class="bi bi-journal-code display-4 text-secondary"></i>
                                </div>
                            {% endif %}

                            {# Switch Overlay #}
                            <div class="position-absolute top-0 end-0 m-2">
                                <div class="form-check form-switch bg-dark bg-opacity-75 px-3 py-1 rounded-pill border border-secondary">
                                    <input class="form-check-input visibility-toggle" type="checkbox"
                                           role="switch" id="switch{{ course.id }}"
                                           data-course-id="{{ course.id }}"
                                           data-course-title="{{ course.title }}"
                                           {% if course.is_public %}checked{% endif %}>
                                    <label class="form-check-label text-white small fw-bold ms-1" for="switch{{ course.id }}">
                                        <span id="label{{ course.id }}">{% if course.is_public %}Public{% else %}Private{% endif %}</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card-body">
                            <h5 class="card-title text-info mb-1">{{ course.title }}</h5>
                            <p class="card-text text-secondary small">{{ course.description|truncatewords:10 }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{# JavaScript for Live Toggle and Console Logging #}
<script>
// Initial setup to check if the "No private courses" message should be visible
function updateEmptyMessage() {
    const privateList = document.getElementById('private-list');
    const noMsg = document.getElementById('no-private-msg');
    const items = privateList.querySelectorAll('li:not(#no-private-msg)');
    if (items.length === 0) {
        noMsg.classList.remove('d-none');
    } else {
        noMsg.classList.add('d-none');
    }
}

// Run on page load
updateEmptyMessage();

document.querySelectorAll('.visibility-toggle').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const courseId = this.dataset.courseId;
        const courseTitle = this.dataset.courseTitle;
        const label = document.getElementById(`label${courseId}`);
        const privateList = document.getElementById('private-list');

        fetch(`/course/toggle-visibility/${courseId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const newState = data.is_public ? 'PUBLIC' : 'PRIVATE';

                // --- CONSOLE LOGGING ---
                console.log(`%c[COURSE UPDATE] %c${courseTitle} %cis now %c${newState}`,
                            "color: #0dcaf0; font-weight: bold;",
                            "color: #ffffff;",
                            "color: #b0b0b0;",
                            data.is_public ? "color: #198754; font-weight: bold;" : "color: #ffc107; font-weight: bold;");

                // Update UI Label
                label.innerText = data.is_public ? 'Public' : 'Private';

                if (!data.is_public) {
                    // Prepend to private list (adds to the top)
                    const newItem = document.createElement('li');
                    newItem.className = "list-group-item bg-dark text-white border-secondary small d-flex justify-content-between align-items-center";
                    newItem.id = `list-item-${courseId}`;
                    newItem.style.borderLeft = "4px solid #ffc107";
                    newItem.innerHTML = `<span class="text-truncate me-2">${courseTitle}</span> <span class="badge bg-secondary">Draft</span>`;

                    privateList.prepend(newItem);
                } else {
                    // Remove from private list
                    const itemToRemove = document.getElementById(`list-item-${courseId}`);
                    if (itemToRemove) itemToRemove.remove();
                }
                updateEmptyMessage();
            }
        })
        .catch(error => {
            console.error('Error updating state:', error);
            this.checked = !this.checked;
        });
    });
});
</script>

<style>
    .form-check-input:checked { background-color: #198754; border-color: #198754; }
    .list-group-item { transition: all 0.3s ease; }
    .list-group-item:hover { background-color: #252525 !important; }
    .text-truncate { max-width: 150px; display: inline-block; vertical-align: middle; }
</style>
{% endblock %}